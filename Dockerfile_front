FROM rust:1.77 as src_builder

WORKDIR /usr/tchatchers/front

RUN apt update

RUN rustup target add wasm32-unknown-unknown

RUN cargo install trunk

COPY ./tchatchers_core ../tchatchers_core

COPY ./tchatchers_macro ../tchatchers_macro

COPY ./tchatchers_front ./

RUN printf "\n[profile.release]\nlto = true\ncodegen-units = 1\nstrip = true\npanic = \"abort\"\nopt-level = \"z\"\n" >> ./Cargo.toml

RUN trunk build --release

FROM ubuntu as compressor

WORKDIR /usr/tchatchers/dist

COPY --from=src_builder /usr/tchatchers/front/tchatchers_front/dist /usr/tchatchers/dist

RUN gzip -r ./*

FROM nginx:alpine-slim

WORKDIR /usr/share/nginx/html

COPY --from=compressor /usr/tchatchers/dist /usr/share/nginx/html

COPY .git/refs/heads/main /usr/share/nginx/html/.rev

COPY ./nginx.conf /etc/nginx/nginx.conf

EXPOSE 80
